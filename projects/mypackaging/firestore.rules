rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for role checking
    function getUserRole(email) {
      return email == 'admin@mypackaging.com' ? 'admin' :
             email == 'khairul@mypackaging.com' ? 'manager' :
             email == 'yeen@mypackaging.com' ? 'manager' :
             email == 'shazila@mypackaging.com' ? 'manager' :
             email == 'masliza@mypackaging.com' ? 'manager' :
             email == 'cashier@mypackaging.com' ? 'staff' : 'staff';
    }
    
    function isAdmin() {
      return request.auth != null && getUserRole(request.auth.token.email) == 'admin';
    }
    
    function isManager() {
      return request.auth != null && getUserRole(request.auth.token.email) == 'manager';
    }
    
    function isStaff() {
      return request.auth != null && getUserRole(request.auth.token.email) == 'staff';
    }
    
    function isManagerOrAdmin() {
      return isAdmin() || isManager();
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function canChangePassword() {
      return isAuthenticated() && request.auth.token.email != 'cashier@mypackaging.com';
    }
    
    // Products collection
    // Admin: full access | Manager: view, create, edit | Staff: view only (for QR scanning)
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow create, update: if isManagerOrAdmin() || isStaff();
      allow delete: if isAdmin();
    }
    
    // Sales collection
    // Admin: full access | Manager: view, create, edit | Staff: view, create
    match /sales/{saleId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isManagerOrAdmin() || isStaff();
      allow delete: if isAdmin();
      
      // Line items subcollection
      match /lineItems/{lineItemId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isManagerOrAdmin() || isStaff();
        allow delete: if isAdmin();
      }
      
      // Payments subcollection (for hutang payment tracking)
      match /payments/{paymentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isManagerOrAdmin();
        allow delete: if isAdmin();
      }
    }
    
    // Purchases collection
    // Admin: full access | Manager: view, create, edit | Staff: no access
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated();
      allow create, update: if isManagerOrAdmin();
      allow delete: if isAdmin();
      
      // Line items subcollection for purchases
      match /lineItems/{lineItemId} {
        allow read: if isAuthenticated();
        allow create, update: if isManagerOrAdmin();
        allow delete: if isAdmin();
      }
    }
    
    // Returns collection (Task 1)
    // Admin: full access | Manager: view, create | Staff: no access
    // Returns track items returned to suppliers (stock added back)
    match /returns/{returnId} {
      allow read: if isAuthenticated();
      allow create: if isManagerOrAdmin();
      allow update: if isManagerOrAdmin();
      allow delete: if isAdmin(); // Only admin can delete returns
    }
    
    // Hutang (Credit) collection
    // Admin: full access | Manager: view, create, edit | Staff: view only
    match /hutang/{hutangId} {
      allow read: if isAuthenticated();
      allow create, update: if isManagerOrAdmin();
      allow delete: if isAdmin();
    }
    
    // Shop Uses collection (Task 2)
    // Admin: full access | Manager: view, create | Staff: no access
    // Shop uses track items used in shop (damaged, samples, personal use)
    match /shopUses/{shopUseId} {
      allow read: if isAuthenticated();
      allow create: if isManagerOrAdmin();
      allow update: if isManagerOrAdmin();
      allow delete: if isAdmin(); // Only admin can delete shop uses
    }
    
    // Transfers collection (Task 2)
    // Admin: full access | Manager: view, create | Staff: no access
    // Transfers track unit conversions between products
    match /transfers/{transferId} {
      allow read: if isAuthenticated();
      allow create: if isManagerOrAdmin();
      allow update: if isManagerOrAdmin();
      allow delete: if isAdmin(); // Only admin can delete transfers
    }
    
    // Stock Audits collection (Task 2)
    // Admin: full access | Others: no access
    // Stock audits are manual stock adjustments with password verification
    match /stockAudits/{auditId} {
      allow read: if isAdmin(); // Only admin can view audits
      allow create: if isAdmin(); // Only admin can create audits
      allow update, delete: if false; // Audits cannot be modified or deleted
    }
    
    // Extra Cash collection
    // Admin: full access | Manager: view, create | Staff: no access
    // Extra cash entries for tracking additional cash found in register
    match /extraCash/{extraCashId} {
      allow read: if isManagerOrAdmin(); // Admin and Manager can view
      allow create: if isManagerOrAdmin(); // Admin and Manager can create
      allow delete: if isAdmin(); // Only admin can delete
      allow update: if false; // Cannot be modified
    }
    
    // Users collection (for user management)
    // Admin: full access | All authenticated users: can read all profiles and update their own status
    match /users/{userId} {
      allow read: if isAuthenticated(); // All users can see other users' profiles and online status
      allow write: if isAdmin(); // Only admin can manage roles
      // Users can update their own online status and profile
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId; // Allow creating own user doc
    }
    
    // Settings collection
    // Admin: full access | Manager: no access | Staff: no access
    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }
    
    // Audit logs collection
    // Admin: full access | Manager: read only | Staff: no access
    // All authenticated users can create audit logs for tracking actions
    match /auditLogs/{logId} {
      allow read: if isManagerOrAdmin();
      allow create: if isAuthenticated(); // All users can create audit logs
      allow update, delete: if isAdmin();
    }
    
    // Reports collection (if you store report configurations)
    // Admin: full access | Manager: view, create | Staff: no access
    match /reports/{reportId} {
      allow read: if isManagerOrAdmin();
      allow create: if isManagerOrAdmin();
      allow update, delete: if isAdmin();
    }
    
    // Stock adjustments collection
    // Admin: full access | Manager: view, create, edit | Staff: no access
    match /stockAdjustments/{adjustmentId} {
      allow read: if isAuthenticated();
      allow create, update: if isManagerOrAdmin();
      allow delete: if isAdmin();
    }
    
    // Suppliers collection
    // Admin: full access | Manager: view, create, edit | Staff: no access
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated();
      allow create, update: if isManagerOrAdmin();
      allow delete: if isAdmin();
    }
    
    // Customer data collection
    // Admin: full access | Manager: view, create, edit | Staff: view, create
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isManagerOrAdmin();
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    // Admin: full access | Manager: view | Staff: view
    match /notifications/{notificationId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // System logs collection
    // Admin: full access | Manager: no access | Staff: no access
    match /systemLogs/{logId} {
      allow read, write: if isAdmin();
    }
    
    // Configuration collection
    // Admin: full access | Manager: read only | Staff: no access
    match /configuration/{configId} {
      allow read: if isManagerOrAdmin();
      allow write: if isAdmin();
    }
    
    // Backup metadata collection
    // Admin: full access | Manager: no access | Staff: no access
    match /backups/{backupId} {
      allow read, write: if isAdmin();
    }

    // Password reset requests collection
    // Any user (authenticated or not) can create requests (for forgot password)
    // Admin can read and update (to process requests)
    match /passwordResetRequests/{requestId} {
      allow create: if true;  // Allow anyone to create password reset requests
      allow read, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Business information collection
    // Admin: full access | Manager: read/write | Staff: read only
    match /businessInfo/{docId} {
      allow read: if isAuthenticated();
      allow write: if isManagerOrAdmin();
    }

    // Payments collection (for hutang payments tracking)
    // Admin: full access | Manager: view, create, edit | Staff: view, create
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isManagerOrAdmin();
      allow delete: if isAdmin();
    }

    // Admin Requests collection (for change requests from staff/managers)
    // All authenticated users can create requests
    // Users can read their own requests
    // Admin can read all requests and update them
    match /adminRequests/{requestId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (isAdmin() || resource.data.submittedBy == request.auth.uid);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Default deny rule for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}